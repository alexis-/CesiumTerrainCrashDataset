# Quantized Terrain Crash

I have created a quantized terrain mesh using `cesium-terrain-builder`. Source file is a DTM tif generated by Reality Capture. More info on the process below.

When loading the terrain in Cesium.js (latest version 1.126) and looking at the boundaries of the terrain area, the following error is often triggered:

```
VM1316 Sandcastle-client.js:42 An error occurred while rendering.  Rendering has stopped.
DeveloperError: normalized result is not a number
Error
    at new DeveloperError (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:9080:13)
    at Cartesian3.normalize (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:9738:13)
    at computeScaledSpaceDirectionToPoint (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:136353:31)
    at computeHorizonCullingPointFromPositions (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:136248:41)
    at EllipsoidalOccluder.computeHorizonCullingPointPossiblyUnderEllipsoid (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:136182:12)
    at computeOccludeePoint2 (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:213813:32)
    at updateTileBoundingRegion (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:213946:52)
    at GlobeSurfaceTileProvider.computeDistanceToTile (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:213821:5)
    at GlobeSurfaceTileProvider.computeTileVisibility (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:213534:28)
    at visitIfVisible (https://sandcastle.cesium.com/CesiumUnminified/Cesium.js:216775:22)
```

## Reproduction Steps

Reproduction steps:
1. Navigate to [Cesium Sandcastle Reproduction](https://sandcastle.cesium.com/#c=dVHLTsMwEPwVKxdSKbVTVeXVUIHKgQOIqjxOuWzdpbFw7MretDzEv+MkIPrCF9vj2ZnZtbTGEyN0DpSZOLtSc3Tsgo3Rq6rk7fa4/cxfnC2fnI6PCqKlPxcCNL4p3+ULRUU148qKrcKxA19cA4FHEkedYW5yIxvjlcJ142dw/ev53GBxHsnmPraGgga6PErYZ27YbtpzBmtQe03k5mvTSaKhrc7AUTiB6TftXOPCIfq4l/KTfn+QsOOUnx2fhsPgNK11WpUCYa7M4k/mDqjgZKcBBuPjQco32EtFsviX2+1tkR2YBQZyPw1wQNvRcAklOuDa2tcritsuks1x3bSRJrXXtNaIf0ImrX/SKnc6wyiJMk/vGkf1FOt1qcqldcSq8JmcC8JyqSGMRcwq+YrEpfd1wJqaic3SbK5WTM0vDnwSkxq8Dy8vldYP6gPzaJSJwN8r1bbJeb9Cp+G9phW90W0Lcs4zEa6HK8laPQO3o/wN)
2. Run (F8)
3. Observe crash

---

## Appendices

### Processing Steps

1. Create DTM in Reality Capture (EPSG:4326), export tif file
2. Rectify tif file `gdalwarp -r cubic -of GTiff -t_srs EPSG:4326 [input_file] [output_file]`
   NOTE: Issue occurs even without this step
3. Use Geodan/terrain docker implementation of ctb to generate quantized terrain tiles
   1. `docker run -it -v $(pwd):/data geodan/terrainwarp -m 1000`
   2. `docker run -it -v $(pwd):/data geodan/terraintiler -s 19 -b 16 -j 30`

### Cesium sandcastle code:

```js
const terrainProvider = Cesium.CesiumTerrainProvider.fromUrl('https://alexis-.github.io/CesiumTerrainCrashDataset/');

const viewer = new Cesium.Viewer("cesiumContainer", {
  terrainProvider: await terrainProvider
});


const rectangle = Cesium.Rectangle.fromDegrees(
  10.7328953, // west
  60.9672950, // south
  10.7377267, // east
  60.9729449  // north
);

const center = Cesium.Cartesian3.fromDegrees(10.7335, 60.9685, 580);
const heading = Cesium.Math.toRadians(50.0);
const pitch = Cesium.Math.toRadians(-10.0);
const range = 300.0;
viewer.camera.lookAt(center, new Cesium.HeadingPitchRange(heading, pitch, range));
```


### DTM GDAL Info

```sh
> gdalinfo dtm_ortho_rectified.tif
Driver: GTiff/GeoTIFF
Files: dtm_ortho_rectified.tif
Size is 34435, 22087
Coordinate System is:
GEOGCRS["WGS 84",
    ENSEMBLE["World Geodetic System 1984 ensemble",
        MEMBER["World Geodetic System 1984 (Transit)"],
        MEMBER["World Geodetic System 1984 (G730)"],
        MEMBER["World Geodetic System 1984 (G873)"],
        MEMBER["World Geodetic System 1984 (G1150)"],
        MEMBER["World Geodetic System 1984 (G1674)"],
        MEMBER["World Geodetic System 1984 (G1762)"],
        MEMBER["World Geodetic System 1984 (G2139)"],
        MEMBER["World Geodetic System 1984 (G2296)"],
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]],
        ENSEMBLEACCURACY[2.0]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["geodetic latitude (Lat)",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["geodetic longitude (Lon)",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    USAGE[
        SCOPE["Horizontal component of 3D system."],
        AREA["World."],
        BBOX[-90,-180,90,180]],
    ID["EPSG",4326]]
Data axis to CRS axis mapping: 2,1
Origin = (10.729225002510383,60.972469264222902)
Pixel Size = (0.000000264047900,-0.000000264047900)
Metadata:
  TIFFTAG_SOFTWARE=RealityCapture
  AREA_OR_POINT=Area
Image Structure Metadata:
  INTERLEAVE=BAND
Corner Coordinates:
Upper Left  (  10.7292250,  60.9724693) ( 10d43'45.21"E, 60d58'20.89"N)
Lower Left  (  10.7292250,  60.9666372) ( 10d43'45.21"E, 60d57'59.89"N)
Upper Right (  10.7383175,  60.9724693) ( 10d44'17.94"E, 60d58'20.89"N)
Lower Right (  10.7383175,  60.9666372) ( 10d44'17.94"E, 60d57'59.89"N)
Center      (  10.7337712,  60.9695533) ( 10d44' 1.58"E, 60d58'10.39"N)
Band 1 Block=34435x1 Type=Float32, ColorInterp=Gray
```